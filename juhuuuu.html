<!DOCTYPE a5185913e6594b29ad57a0642f4c979d>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Klassenplattform 8B â€” Clean + Emoji Game</title>
<style>
:root{
Â  --bg:#07111a; --card:#0b1722; --muted:#9fb0bf;
Â  --accent-1:#27e3c4; --accent-2:#36a9ff; --text:#e6eef6;
Â  --soft: rgba(255,255,255,0.02); --radius:12px;
}
body.light{ --bg:#f6f8fb; --card:#ffffff; --muted:#546070; --text:#0b1220; --soft: rgba(0,0,0,0.04); }
body.green{ --bg:#071614; --card:#081815; --muted:#9fbfae; --accent-1:#6ee37f; --accent-2:#27e3c4; --text:#e9f7ef; --soft: rgba(255,255,255,0.02); }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);min-height:100vh}
.container{max-width:1100px;margin:18px auto;padding:0 16px}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;flex-direction:column}
.appName{font-weight:800;font-size:18px}
.appSub{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center}
.iconBtn{background:transparent;border:none;padding:8px;border-radius:10px;color:var(--text);cursor:pointer}
.iconBtn:hover{background:var(--soft)}
.profileBtn{width:44px;height:44px;border-radius:12px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#001a1a;font-weight:800;cursor:pointer}
.leftLayout{display:flex;gap:16px;margin-top:16px}
.sidebar{width:220px;background:var(--card);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,0.4)}
.logo{display:flex;align-items:center;gap:10px}
.logoCircle{width:44px;height:44px;border-radius:10px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#021017;font-weight:800}
.navItem{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer;color:var(--text)}
.navItem:hover{background:var(--soft)}
.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#001a1a}
.small{font-size:13px;color:var(--muted)}
.content{flex:1;display:flex;flex-direction:column;gap:16px}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.35)}
.hero{display:flex;align-items:center;justify-content:space-between;padding:28px;border-radius:14px;background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
.heroGreeting{font-size:28px;font-weight:800;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}
.input{width:100%;padding:10px;border-radius:10px;border:none;background:var(--soft);color:var(--text);margin-top:8px}
.textarea{min-height:96px;padding:10px;border-radius:10px;border:none;background:var(--soft);color:var(--text);resize:vertical}
.postRow{display:flex;gap:12px;align-items:flex-start}
.initialCircle{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#001a1a}
.postCard{display:flex;gap:12px;padding:12px;border-radius:12px;background:rgba(0,0,0,0.02);margin-top:12px}
.meta{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;margin-top:8px}
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;background:transparent;color:var(--text)}
.btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#001a1a;font-weight:700}
.comment{background:var(--soft);padding:8px;border-radius:8px;margin-top:8px}
.chatSidebar{position:fixed;right:18px;top:84px;width:360px;height:76vh;background:var(--card);border-radius:12px;padding:12px;box-shadow:0 12px 36px rgba(0,0,0,0.5);transform:translateX(420px);transition:transform .22s;z-index:99;display:flex;flex-direction:column}
.chatSidebar.open{transform:translateX(0)}
.chatUsers{display:flex;flex-direction:column;gap:8px;max-height:160px;overflow:auto;margin-top:8px}
.chatWindow{display:flex;flex-direction:column;flex:1;margin-top:8px;overflow:hidden}
.messages{flex:1;overflow:auto;padding:8px}
.msg{margin-bottom:8px;max-width:82%}
.msg.me{margin-left:auto;text-align:right}
.msg .bubble{display:inline-block;padding:8px 10px;border-radius:10px;background:var(--soft)}
.msg.me .bubble{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#001a1a}
.unread{background:#ff3b30;color:white;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:8px}
.profilePanel{position:fixed;right:18px;top:84px;width:320px;background:var(--card);padding:14px;border-radius:12px;box-shadow:0 12px 36px rgba(0,0,0,0.5);display:none;z-index:100}
.colorPreview{width:40px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.05);cursor:pointer}
.colorRow{display:flex;gap:8px;align-items:center;margin-top:8px}
.emojiGame{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px}
.emojiBig{font-size:72px;cursor:pointer;user-select:none;transition:transform .08s}
.particle{position:fixed;pointer-events:none;font-size:20px;opacity:0;transform:translate(-50%,-50%) scale(.6);transition:transform .45s,opacity .45s}
.progressBar{height:8px;border-radius:8px;background:var(--soft);overflow:hidden}
.progressFill{height:100%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));width:0%}
.hidden{display:none}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:18px}
/* responsive */
@media(max-width:980px){ .leftLayout{flex-direction:column} .sidebar{width:100%} .chatSidebar{right:8px;width:92vw;top:80px} .profilePanel{right:8px} }
</style>
</head>
<body>
<div class="container">
Â  <div class="topbar">
Â  Â  <div class="brand">
Â  Â  Â  <div class="appName">Klasse 8B</div>
Â  Â  Â  <div class="appSub small">Schulplattform â€” Clean & Fun</div>
Â  Â  </div>
Â  Â  <div class="controls">
Â  Â  Â  <button id="bellBtn" class="iconBtn" title="Benachrichtigungen">ğŸ”” <span id="bellCount" class="unread hidden">0</span></button>
Â  Â  Â  <button id="chatToggle" class="iconBtn" title="Chat">ğŸ’¬</button>
Â  Â  Â  <div id="profileBtn" class="profileBtn" title="Profil">?</div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="authCard" class="card authCard">
Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  <div>
Â  Â  Â  Â  <h2 style="margin:0">Willkommen</h2>
Â  Â  Â  Â  <div class="small">Melde dich an oder registriere dich (KÃ¼rzel = <b>8bschul</b>).</div>
Â  Â  Â  </div>
Â  Â  Â  <div style="text-align:right" class="small">Klasse 8B</div>
Â  Â  </div>

Â  Â  <div id="authForms" style="margin-top:14px;display:flex;gap:14px">
Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  <div id="loginForm">
Â  Â  Â  Â  Â  <input id="loginUser" class="input" placeholder="Benutzername">
Â  Â  Â  Â  Â  <input id="loginPass" class="input" type="password" placeholder="Passwort">
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
Â  Â  Â  Â  Â  Â  <button id="showReg" class="btn">Registrieren</button>
Â  Â  Â  Â  Â  Â  <button id="loginBtn" class="btn primary">Anmelden</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="loginMsg" class="small" style="color:#ff8aa1;margin-top:8px"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="regForm" class="hidden" style="margin-top:10px">
Â  Â  Â  Â  Â  <input id="regFirst" class="input" placeholder="Vorname">
Â  Â  Â  Â  Â  <input id="regLast" class="input" placeholder="Nachname">
Â  Â  Â  Â  Â  <input id="regUser" class="input" placeholder="GewÃ¼nschter Benutzername">
Â  Â  Â  Â  Â  <input id="regPass" class="input" type="password" placeholder="Passwort">
Â  Â  Â  Â  Â  <input id="regCode" class="input" placeholder="KÃ¼rzel (8bschul)">
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
Â  Â  Â  Â  Â  Â  <button id="cancelReg" class="btn">Abbrechen</button>
Â  Â  Â  Â  Â  Â  <button id="regBtn" class="btn primary">Registrieren</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="regMsg" class="small" style="color:#7ee3ff;margin-top:8px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div style="width:280px">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
Â  Â  Â  Â  Â  Â  <div class="logoCircle" style="width:72px;height:72px;font-size:28px">8B</div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Klasse 8B</div>
Â  Â  Â  Â  Â  Â  <div class="small">Gutes Lernen. Besserer Stil.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div id="appLayout" class="leftLayout hidden">
Â  Â  <div class="sidebar">
Â  Â  Â  <div class="logo">
Â  Â  Â  Â  <div class="logoCircle">8B</div>
Â  Â  Â  Â  <div style="display:flex;flex-direction:column">
Â  Â  Â  Â  Â  <div style="font-weight:800">Klasse 8B</div>
Â  Â  Â  Â  Â  <div class="small">Dashboard</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="navHome" class="navItem active">ğŸ  Start</div>
Â  Â  Â  <div id="navPosts" class="navItem">ğŸ“° Posts</div>
Â  Â  Â  <div id="navChat" class="navItem">ğŸ’¬ Chat</div>
Â  Â  Â  <div id="navGame" class="navItem">ğŸ•¹ï¸ Emoji-Klicker</div>
Â  Â  Â  <div id="navProfile" class="navItem">âš™ï¸ Profil</div>
Â  Â  Â  <div id="navLogout" class="navItem">ğŸšª Logout</div>

Â  Â  Â  <div class="sidebarFooter small">Angemeldet als <span id="sidebarUser">â€”</span></div>
Â  Â  </div>

Â  Â  <div class="content">
Â  Â  Â  <div id="viewHome" class="card">
Â  Â  Â  Â  <div class="hero">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="heroGreeting" id="heroGreeting">Hallo, Guest ğŸ‘‹</div>
Â  Â  Â  Â  Â  Â  <div class="small" id="heroSub">SchÃ¶n, dass du da bist â€” wÃ¤hle links ein MenÃ¼.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align:right">
Â  Â  Â  Â  Â  Â  <div class="small">Schnellzugriff</div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  Â  Â  <button id="quickPost" class="btn">ğŸ“ Posten</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quickChat" class="btn">ğŸ’¬ Chat</button>
Â  Â  Â  Â  Â  Â  Â  <button id="quickGame" class="btn">ğŸ® Spiel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="viewPosts" class="hidden">
Â  Â  Â  Â  <div class="card">
Â  Â  Â  Â  Â  <div style="display:flex;gap:12px;align-items:flex-start">
Â  Â  Â  Â  Â  Â  <div class="initialCircle" id="composerInitial">A</div>
Â  Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  Â  <textarea id="postInput" class="textarea" placeholder="Schreibe etwas fÃ¼r die Klasse..."></textarea>
Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="postBtn" class="btn primary">Posten</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="feedArea"></div>
Â  Â  Â  </div>

Â  Â  Â  <div id="viewChat" class="hidden">
Â  Â  Â  Â  <div class="card" style="display:flex;gap:12px">
Â  Â  Â  Â  Â  <div style="width:260px">
Â  Â  Â  Â  Â  Â  <div class="small">Kontakte</div>
Â  Â  Â  Â  Â  Â  <div id="contactsList" class="chatUsers"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:1;display:flex;flex-direction:column">
Â  Â  Â  Â  Â  Â  <div class="small" id="chatHeaderFull">WÃ¤hle einen Kontakt</div>
Â  Â  Â  Â  Â  Â  <div id="chatFullMessages" class="messages" style="background:transparent"></div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  Â  Â  Â  Â  <input id="chatFullInput" class="input" placeholder="Nachricht...">
Â  Â  Â  Â  Â  Â  Â  <button id="chatFullSend" class="btn primary">Senden</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="viewGame" class="hidden">
Â  Â  Â  Â  <div class="card emojiGame">
Â  Â  Â  Â  Â  <div style="display:flex;align-items:center;gap:12px">
Â  Â  Â  Â  Â  Â  <div class="initialCircle" id="gameInitial" style="width:64px;height:64px;font-size:24px">EK</div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:800" id="gameTitle">Emoji Klicker</div>
Â  Â  Â  Â  Â  Â  Â  <div class="small">Klicke das Emoji, sammle Punkte & schalte neue frei!</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
Â  Â  Â  Â  Â  Â  <div style="font-size:18px">Punkte:</div>
Â  Â  Â  Â  Â  Â  <div id="gamePoints" style="font-weight:800;font-size:20px">0</div>
Â  Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  Â  <div class="progressBar"><div id="gameProgress" class="progressFill"></div></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="margin-top:8px;display:flex;gap:12px;align-items:center">
Â  Â  Â  Â  Â  Â  <div id="activeEmoji" class="emojiBig">ğŸ˜€</div>
Â  Â  Â  Â  Â  Â  <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-start">
Â  Â  Â  Â  Â  Â  Â  <div class="small">Freigeschaltet:</div>
Â  Â  Â  Â  Â  Â  Â  <div id="unlockedList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  <button id="upgradeBtn" class="btn">Upgrade (x2 fÃ¼r 20 Punkte)</button>
Â  Â  Â  Â  Â  Â  <button id="resetGame" class="btn">Reset</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div id="viewProfile" class="hidden">
Â  Â  Â  Â  <div class="card" style="display:flex;gap:12px;align-items:center">
Â  Â  Â  Â  Â  <div class="initialCircle" id="profileInitial" style="width:84px;height:84px;font-size:36px">A</div>
Â  Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  Â  <div id="profileName" style="font-weight:800">Name</div>
Â  Â  Â  Â  Â  Â  <div class="small" id="profileUser">@user</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  Â  Â  <label class="small">Hintergrund (Live-Preview)</label>
Â  Â  Â  Â  Â  Â  Â  <div class="colorRow">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewDark" class="colorPreview" style="background:#07111a"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewLight" class="colorPreview" style="background:#f6f8fb"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="previewGreen" class="colorPreview" style="background:#071614"></div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <select id="themeSelect" class="input" style="margin-top:8px">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="dark">Dunkel (Standard)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="light">Hell</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="green">GrÃ¼n</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="footer">Â© Klasse 8B â€” Clean UI</div>
Â  Â  </div>

Â  </div>
</div>

<div id="chatSidebar" class="chatSidebar">
Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  <div style="font-weight:800">Chat</div>
Â  Â  <div>
Â  Â  Â  <button id="chatClose" class="iconBtn">âœ–</button>
Â  Â  </div>
Â  </div>

Â  <div style="margin-top:8px">
Â  Â  <div class="small">Kontakte</div>
Â  Â  <div id="chatContactsRight" class="chatUsers"></div>
Â  </div>

Â  <div class="chatWindow" id="chatSidebarWindow" style="display:none">
Â  Â  <div id="chatSidebarTitle" style="padding:8px;border-bottom:1px solid var(--soft)">â€”</div>
Â  Â  <div id="chatSidebarMessages" class="messages"></div>
Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  <input id="chatSidebarInput" class="input" placeholder="Nachricht...">
Â  Â  Â  <button id="chatSidebarSend" class="btn primary">Senden</button>
Â  Â  </div>
Â  </div>
</div>

<div id="profilePanel" class="profilePanel">
Â  <div style="display:flex;flex-direction:column;gap:8px;align-items:center">
Â  Â  <div class="initialCircle" id="panelInitialLarge" style="width:96px;height:96px;font-size:36px">A</div>
Â  Â  <div id="panelName" style="font-weight:800">Name</div>
Â  Â  <div id="panelUser" class="small">@user</div>

Â  Â  <div style="width:100%;margin-top:8px">
Â  Â  Â  <label class="small">Hintergrund (Live-Vorschau)</label>
Â  Â  Â  <div class="colorRow">
Â  Â  Â  Â  <div id="panelPreviewDark" class="colorPreview" style="background:#07111a"></div>
Â  Â  Â  Â  <div id="panelPreviewLight" class="colorPreview" style="background:#f6f8fb"></div>
Â  Â  Â  Â  <div id="panelPreviewGreen" class="colorPreview" style="background:#071614"></div>
Â  Â  Â  </div>
Â  Â  Â  <select id="panelThemeSelect" class="input" style="margin-top:8px">
Â  Â  Â  Â  <option value="dark">Dunkel</option>
Â  Â  Â  Â  <option value="light">Hell</option>
Â  Â  Â  Â  <option value="green">GrÃ¼n</option>
Â  Â  Â  </select>
Â  Â  </div>

Â  Â  <div style="display:flex;gap:8px;margin-top:8px">
Â  Â  Â  <button id="panelClose" class="btn">SchlieÃŸen</button>
Â  Â  Â  <button id="panelLogout" class="btn">Logout</button>
Â  Â  </div>
Â  </div>
</div>

<footer style="height:20px"></footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyDsW9JKhyBmlxv-BAcAa4gyHOX6R-KLoQA",
Â  authDomain: "englischfairytale8b.firebaseapp.com",
Â  databaseURL: "https://englischfairytale8b-default-rtdb.firebaseio.com",
Â  projectId: "englischfairytale8b",
Â  storageBucket: "englischfairytale8b.appspot.com",
Â  messagingSenderId: "1009055770845",
Â  appId: "1:1009055770845:web:56ab77e4788b4bc4ced334"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* DOM refs */
const authCard = document.getElementById('authCard');
const showReg = document.getElementById('showReg');
const regForm = document.getElementById('regForm');
const cancelReg = document.getElementById('cancelReg');
const regBtn = document.getElementById('regBtn');
const loginBtn = document.getElementById('loginBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const loginMsg = document.getElementById('loginMsg');
const regMsg = document.getElementById('regMsg');

const appLayout = document.getElementById('appLayout');
const navHome = document.getElementById('navHome');
const navPosts = document.getElementById('navPosts');
const navChat = document.getElementById('navChat');
const navGame = document.getElementById('navGame');
const navProfile = document.getElementById('navProfile');
const navLogout = document.getElementById('navLogout');

const viewHome = document.getElementById('viewHome');
const viewPosts = document.getElementById('viewPosts');
const viewChat = document.getElementById('viewChat');
const viewGame = document.getElementById('viewGame');
const viewProfile = document.getElementById('viewProfile');

const heroGreeting = document.getElementById('heroGreeting');
const composerInitial = document.getElementById('composerInitial');
const postInput = document.getElementById('postInput');
const postBtn = document.getElementById('postBtn');
const feedArea = document.getElementById('feedArea');

const contactsList = document.getElementById('contactsList');
const chatFullMessages = document.getElementById('chatFullMessages');
const chatFullInput = document.getElementById('chatFullInput');
const chatFullSend = document.getElementById('chatFullSend');
const chatHeaderFull = document.getElementById('chatHeaderFull');

const profileBtn = document.getElementById('profileBtn');
const profilePanel = document.getElementById('profilePanel');
const panelClose = document.getElementById('panelClose');
const panelLogout = document.getElementById('panelLogout');
const panelInitialLarge = document.getElementById('panelInitialLarge');
const panelName = document.getElementById('panelName');
const panelUser = document.getElementById('panelUser');
const panelThemeSelect = document.getElementById('panelThemeSelect');

const themeSelect = document.getElementById('themeSelect');
const profileInitial = document.getElementById('profileInitial');
const profileName = document.getElementById('profileName');
const profileUser = document.getElementById('profileUser');
const sidebarUser = document.getElementById('sidebarUser');

const chatToggle = document.getElementById('chatToggle');
const chatSidebar = document.getElementById('chatSidebar');
const chatContactsRight = document.getElementById('chatContactsRight');
const chatSidebarWindow = document.getElementById('chatSidebarWindow');
const chatSidebarMessages = document.getElementById('chatSidebarMessages');
const chatSidebarTitle = document.getElementById('chatSidebarTitle');
const chatSidebarInput = document.getElementById('chatSidebarInput');
const chatSidebarSend = document.getElementById('chatSidebarSend');
const chatClose = document.getElementById('chatClose');

const bellBtn = document.getElementById('bellBtn');
const bellCount = document.getElementById('bellCount');

const previewDark = document.getElementById('previewDark');
const previewLight = document.getElementById('previewLight');
const previewGreen = document.getElementById('previewGreen');
const panelPreviewDark = document.getElementById('panelPreviewDark');
const panelPreviewLight = document.getElementById('panelPreviewLight');
const panelPreviewGreen = document.getElementById('panelPreviewGreen');

const navGameBtn = document.getElementById('navGame');
const activeEmoji = document.getElementById('activeEmoji');
const gamePointsEl = document.getElementById('gamePoints');
const gameProgress = document.getElementById('gameProgress');
const unlockedList = document.getElementById('unlockedList');
const upgradeBtn = document.getElementById('upgradeBtn');
const resetGameBtn = document.getElementById('resetGame');

let currentUser = null; // {username,first,last,uid,isAdmin,theme}
let currentChatUid = null; // Der uid des gerade chat-partners
let unreadTotal = 0;
let usersCache = {}; // Cache fÃ¼r Benutzerinformationen

/* helpers */
const uidFor = name => name.replace(/\s+/g,'_').toLowerCase();
const now = () => Date.now();
const el = (t,txt)=>{const d=document.createElement(t); if(txt!==undefined) d.textContent=txt; return d;};

/* NAV/helpers */
function setActive(navEl){
Â  [navHome,navPosts,navChat,navGame,navProfile].forEach(n=>n.classList.remove('active'));
Â  navEl.classList.add('active');
}
function showView(view){
Â  [viewHome,viewPosts,viewChat,viewGame,viewProfile].forEach(v=>v.classList.add('hidden'));
Â  view.classList.remove('hidden');
}

/* UI: register/login toggle */
showReg.addEventListener('click', ()=>{ regForm.classList.remove('hidden'); document.getElementById('loginForm').classList.add('hidden'); });
document.getElementById('cancelReg').addEventListener('click', ()=>{ regForm.classList.add('hidden'); document.getElementById('loginForm').classList.remove('hidden'); });

/* REGISTER */
regBtn.addEventListener('click', async ()=>{
Â  regMsg.textContent='';
Â  const first = document.getElementById('regFirst').value.trim();
Â  const last = document.getElementById('regLast').value.trim();
Â  const username = document.getElementById('regUser').value.trim();
Â  const password = document.getElementById('regPass').value;
Â  const code = document.getElementById('regCode').value.trim();
Â  if(!first||!last||!username||!password){ regMsg.textContent='Bitte alle Felder ausfÃ¼llen.'; return; }
Â  if(code !== '8bschul'){ regMsg.textContent='UngÃ¼ltiges KÃ¼rzel.'; return; }
Â  const uid = uidFor(username);
Â  const userRef = ref(db, `users/${uid}`);
Â  const snap = await get(userRef);
Â  if(snap.exists()){ regMsg.textContent='Benutzername bereits vergeben.'; return; }
Â  await set(userRef, {username,first,last,password,code,uid,isAdmin:false,theme:'dark',points:0,multiplier:1,unlockedEmojis:['ğŸ˜€']});
Â  currentUser = {username,first,last,uid,isAdmin:false,theme:'dark',points:0,multiplier:1,unlockedEmojis:['ğŸ˜€']};
Â  afterLogin();
});

/* LOGIN */
loginBtn.addEventListener('click', async ()=>{
Â  loginMsg.textContent='';
Â  const username = loginUser.value.trim();
Â  const password = loginPass.value;
Â  if(username === 'Letsseimen' && password === '261011'){
Â  Â  const uid = uidFor(username);
Â  Â  const uref = ref(db, `users/${uid}`);
Â  Â  const s = await get(uref);
Â  Â  if(!s.exists()){
Â  Â  Â  await set(uref, {username:'Letsseimen',first:'Seimen',last:'',password:'261011',code:'8bschul',uid,isAdmin:true,theme:'dark',points:0,multiplier:1,unlockedEmojis:['ğŸ˜€']});
Â  Â  } else {
Â  Â  Â  await update(uref, {isAdmin:true});
Â  Â  }
Â  Â  currentUser = (await get(uref)).val();
Â  Â  afterLogin(); return;
Â  }
Â  const uid = uidFor(username);
Â  const snap = await get(ref(db, `users/${uid}`));
Â  if(!snap.exists()){ loginMsg.textContent='Benutzer nicht gefunden.'; return; }
Â  const data = snap.val();
Â  if(data.password !== password){ loginMsg.textContent='Falsches Passwort.'; return; }
Â  if(data.code !== '8bschul'){ loginMsg.textContent='KÃ¼rzel ungÃ¼ltig.'; return; }
Â  currentUser = {...data};
Â  afterLogin();
});

/* POSTEN-LISTENER */
postBtn.addEventListener('click', async ()=>{
Â  const text = postInput.value.trim();
Â  if(!text) return;
Â  const p = push(ref(db,'posts'));
Â  await set(p, {author: currentUser.username, authorUid: currentUser.uid, text, time: now()});
Â  postInput.value='';
});


/* AFTER LOGIN */
async function afterLogin(){
Â  document.getElementById('authCard').style.display='none';
Â  document.getElementById('appLayout').classList.remove('hidden');
Â  heroGreeting.textContent = `Hallo, ${currentUser.first || currentUser.username} ğŸ‘‹`;
Â  composerInitial.textContent = (currentUser.username||'?').charAt(0).toUpperCase();
Â  profileInitial.textContent = (currentUser.username||'?').charAt(0).toUpperCase();
Â  panelInitialLarge.textContent = (currentUser.username||'?').charAt(0).toUpperCase();
Â  panelName.textContent = `${currentUser.first || ''} ${currentUser.last || ''}`;
Â  panelUser.textContent = `@${currentUser.username}`;
Â  profileBtn.textContent = (currentUser.username||'?').charAt(0).toUpperCase();
Â  sidebarUser.textContent = currentUser.username;

Â  // apply theme saved
Â  if(currentUser.theme === 'light'){ document.body.classList.add('light'); document.body.classList.remove('green'); }
Â  else if(currentUser.theme === 'green'){ document.body.classList.add('green'); document.body.classList.remove('light'); }
Â  else { document.body.classList.remove('light'); document.body.classList.remove('green'); }

Â  // Initialisiere alle Firebase Listener NUR EINMAL
Â  renderFeed();
Â  renderContacts();
Â  renderChatContactsRight();
Â  updateChatsList();
Â  computeUnread();
Â  onValue(ref(db,'chats'), ()=> computeUnread());

Â  // nav bindings
Â  navHome.addEventListener('click', ()=>{ setActive(navHome); showView(viewHome); });
Â  navPosts.addEventListener('click', ()=>{ setActive(navPosts); showView(viewPosts); });
Â  navChat.addEventListener('click', ()=>{ setActive(navChat); showView(viewChat); });
Â  navGame.addEventListener('click', ()=>{ setActive(navGame); showView(viewGame); initEmojiGame(); });
Â  navProfile.addEventListener('click', ()=>{ setActive(navProfile); showView(viewProfile); });
Â  navLogout.addEventListener('click', ()=> logout());
Â  document.getElementById('quickPost').addEventListener('click', ()=>{ setActive(navPosts); showView(viewPosts); });
Â  document.getElementById('quickChat').addEventListener('click', ()=>{ setActive(navChat); showView(viewChat); });
Â  document.getElementById('quickGame').addEventListener('click', ()=>{ setActive(navGame); showView(viewGame); initEmojiGame(); });

Â  // Profil und Theme
Â  profileBtn.addEventListener('click', ()=> profilePanel.style.display = profilePanel.style.display === 'block' ? 'none' : 'block');
Â  panelClose.addEventListener('click', ()=> profilePanel.style.display='none');
Â  panelLogout.addEventListener('click', ()=> logout());

Â  themeSelect.addEventListener('change', e => setTheme(e.target.value));
Â  panelThemeSelect.addEventListener('change', e => setTheme(e.target.value));

Â  previewDark.addEventListener('click', ()=> setTheme('dark'));
Â  previewLight.addEventListener('click', ()=> setTheme('light'));
Â  previewGreen.addEventListener('click', ()=> setTheme('green'));
Â  panelPreviewDark.addEventListener('click', ()=> setTheme('dark'));
Â  panelPreviewLight.addEventListener('click', ()=> setTheme('light'));
Â  panelPreviewGreen.addEventListener('click', ()=> setTheme('green'));

Â  // Chat-Toggle
Â  chatToggle.addEventListener('click', ()=> chatSidebar.classList.toggle('open'));
Â  chatClose.addEventListener('click', ()=> chatSidebar.classList.remove('open'));

Â  // Emoji Game:
Â  activeEmoji.addEventListener('click', clickEmoji);
Â  upgradeBtn.addEventListener('click', upgradeMultiplier);
Â  resetGameBtn.addEventListener('click', resetGame);

Â  // Local Storage
Â  localStorage.setItem('loggedUser', currentUser.uid);

Â  // initialisiere Game nur einmal
Â  initEmojiGame(true);
}

/* LOGOUT */
function logout(){ localStorage.removeItem('loggedUser'); location.reload(); }

/* POSTS */
/* RENDER FEED */
function renderFeed(){
Â  composerInitial.textContent = (currentUser.username||'?').charAt(0).toUpperCase();
Â  const postsRef = ref(db,'posts');
Â  // Sicherstellung, dass der Listener nur einmal gebunden wird
Â  if(renderFeed._bound) return;
Â  renderFeed._bound = true;

Â  onValue(postsRef, snap=>{
Â  Â  const data = snap.val() || {};
Â  Â  feedArea.innerHTML = '';
Â  Â  const entries = Object.entries(data).sort((a,b)=>b[1].time - a[1].time);
Â  Â  entries.forEach(([key,p])=>{
Â  Â  Â  const block = document.createElement('div'); block.className='postCard';
Â  Â  Â  const left = document.createElement('div'); left.innerHTML = `<div class="initialCircle">${(p.author||'?').charAt(0).toUpperCase()}</div>`;
Â  Â  Â  const body = document.createElement('div'); body.style.flex='1';
Â  Â  Â  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `${p.author} â€¢ ${new Date(p.time).toLocaleString()}`;
Â  Â  Â  const txt = document.createElement('div'); txt.style.marginTop='8px'; txt.textContent = p.text || '';
Â  Â  Â  body.appendChild(meta); body.appendChild(txt);

Â  Â  Â  const acts = document.createElement('div'); acts.className='actions';
Â  Â  Â  const likeBtn = el('button', `â¤ï¸ ${p.likes ? Object.keys(p.likes).length : 0}`); likeBtn.className='btn like';
Â  Â  Â  likeBtn.addEventListener('click', async ()=>{
Â  Â  Â  Â  const likePath = `posts/${key}/likes/${currentUser.uid}`;
Â  Â  Â  Â  const cur = (await get(ref(db, likePath))).exists();
Â  Â  Â  Â  if(cur) await set(ref(db, likePath), null); else await set(ref(db, likePath), true);
Â  Â  Â  });
Â  Â  Â  acts.appendChild(likeBtn);

Â  Â  Â  if(currentUser.username === p.author){
Â  Â  Â  Â  const editBtn = el('button','âœï¸'); editBtn.className='btn';
Â  Â  Â  Â  editBtn.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  const ta = document.createElement('textarea'); ta.className='textarea'; ta.value = p.text || '';
Â  Â  Â  Â  Â  const save = el('button','ğŸ’¾'); save.className='btn primary';
Â  Â  Â  Â  Â  save.addEventListener('click', ()=> update(ref(db, `posts/${key}`), {text: ta.value}));
Â  Â  Â  Â  Â  body.replaceChild(ta, txt);
Â  Â  Â  Â  Â  acts.appendChild(save);
Â  Â  Â  Â  });
Â  Â  Â  Â  acts.appendChild(editBtn);
Â  Â  Â  }
Â  Â  Â  if(currentUser.isAdmin || currentUser.username === p.author){
Â  Â  Â  Â  const del = el('button','ğŸ—‘'); del.className='btn';
Â  Â  Â  Â  del.addEventListener('click', ()=>{ if(confirm('Post lÃ¶schen?')) set(ref(db, `posts/${key}`), null); });
Â  Â  Â  Â  acts.appendChild(del);
Â  Â  Â  }
Â  Â  Â  body.appendChild(acts);

Â  Â  Â  const commentBox = document.createElement('div'); commentBox.className='commentBox';
Â  Â  Â  const inpt = document.createElement('input'); inpt.className='input'; inpt.placeholder='Kommentiere...';
Â  Â  Â  inpt.addEventListener('keydown', e=>{
Â  Â  Â  Â  if(e.key === 'Enter' && inpt.value.trim()){
Â  Â  Â  Â  Â  push(ref(db, `posts/${key}/comments`), {author: currentUser.username, authorUid: currentUser.uid, text: inpt.value.trim(), time: now()});
Â  Â  Â  Â  Â  inpt.value='';
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  commentBox.appendChild(inpt);
Â  Â  Â  if(p.comments){
Â  Â  Â  Â  Object.entries(p.comments).forEach(([ck,c])=>{
Â  Â  Â  Â  Â  const cd = document.createElement('div'); cd.className='comment';
Â  Â  Â  Â  Â  cd.innerHTML = `<div class="meta"><b>${c.author}</b> â€¢ ${new Date(c.time).toLocaleString()}</div><div class="cText">${c.text}</div>`;
Â  Â  Â  Â  Â  if(currentUser.uid === c.authorUid){
Â  Â  Â  Â  Â  Â  const eb = el('button','âœï¸'); eb.className='btn';
Â  Â  Â  Â  Â  Â  eb.addEventListener('click', ()=>{
Â  Â  Â  Â  Â  Â  Â  const ta = document.createElement('textarea'); ta.className='textarea'; ta.value = c.text;
Â  Â  Â  Â  Â  Â  Â  const sv = el('button','ğŸ’¾'); sv.className='btn primary';
Â  Â  Â  Â  Â  Â  Â  sv.addEventListener('click', ()=> update(ref(db, `posts/${key}/comments/${ck}`), {text: ta.value}));
Â  Â  Â  Â  Â  Â  Â  cd.querySelector('.cText').replaceWith(ta);
Â  Â  Â  Â  Â  Â  Â  cd.appendChild(sv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const dl = el('button','ğŸ—‘'); dl.className='btn';
Â  Â  Â  Â  Â  Â  dl.addEventListener('click', ()=>{ if(confirm('Kommentar lÃ¶schen?')) set(ref(db, `posts/${key}/comments/${ck}`), null); });
Â  Â  Â  Â  Â  Â  cd.appendChild(eb); cd.appendChild(dl);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if(currentUser.isAdmin && currentUser.uid !== c.authorUid){
Â  Â  Â  Â  Â  Â  const dl2 = el('button','ğŸ—‘(Admin)'); dl2.className='btn';
Â  Â  Â  Â  Â  Â  dl2.addEventListener('click', ()=>{ if(confirm('Admin lÃ¶scht Kommentar?')) set(ref(db, `posts/${key}/comments/${ck}`), null); });
Â  Â  Â  Â  Â  Â  cd.appendChild(dl2);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  commentBox.appendChild(cd);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  body.appendChild(commentBox);

Â  Â  Â  block.appendChild(left); block.appendChild(body);
Â  Â  Â  feedArea.appendChild(block);
Â  Â  });
Â  });
}


/* CONTACTS + CHAT */
function renderContacts(){
Â  const usersRef = ref(db, 'users');
Â  if(renderContacts._bound) return;
Â  renderContacts._bound = true;

Â  onValue(usersRef, snap=>{
Â  Â  contactsList.innerHTML = '';
Â  Â  usersCache = {};
Â  Â  snap.forEach(s=>{
Â  Â  Â  const u = s.val();
Â  Â  Â  if(!u.code || u.code !== '8bschul' || u.uid === currentUser.uid) return;
Â  Â  Â  usersCache[u.uid] = u;
Â  Â  Â  const row = document.createElement('div'); row.className='navItem';
Â  Â  Â  const initials = el('div', (u.username||'?').charAt(0).toUpperCase()); initials.className='logoCircle'; initials.style.width='36px'; initials.style.height='36px'; initials.style.fontSize='14px';
Â  Â  Â  row.appendChild(initials);
Â  Â  Â  row.appendChild(el('span', u.first || u.username));
Â  Â  Â  row.setAttribute('data-uid', u.uid);
Â  Â  Â  row.addEventListener('click', ()=> startChat(u.uid, u.first || u.username, false));
Â  Â  Â  contactsList.appendChild(row);
Â  Â  });
Â  });
}

function renderChatContactsRight(){
Â  const usersRef = ref(db, 'users');
Â  if(renderChatContactsRight._bound) return;
Â  renderChatContactsRight._bound = true;

Â  onValue(usersRef, snap=>{
Â  Â  chatContactsRight.innerHTML = '';
Â  Â  snap.forEach(s=>{
Â  Â  Â  const u = s.val();
Â  Â  Â  if(!u.code || u.code !== '8bschul' || u.uid === currentUser.uid) return;
Â  Â  Â  const row = document.createElement('div'); row.className='navItem';
Â  Â  Â  const initials = el('div', (u.username||'?').charAt(0).toUpperCase()); initials.className='logoCircle'; initials.style.width='30px'; initials.style.height='30px'; initials.style.fontSize='12px';
Â  Â  Â  row.appendChild(initials);
Â  Â  Â  row.appendChild(el('span', u.first || u.username));
Â  Â  Â  row.setAttribute('data-uid', u.uid);
Â  Â  Â  row.addEventListener('click', ()=> startChat(u.uid, u.first || u.username, true));
Â  Â  Â  chatContactsRight.appendChild(row);
Â  Â  });
Â  });
}


function getChatId(otherUid){
Â  return currentUser.uid < otherUid ? `${currentUser.uid}_${otherUid}` : `${otherUid}_${currentUser.uid}`;
}

function updateChatsList(){
Â  const chatsRef = ref(db,'chats');
Â  if(updateChatsList._bound) return;
Â  updateChatsList._bound = true;

Â  onValue(chatsRef, snap=>{
Â  Â  let chatData = snap.val() || {};
Â  Â  let myChats = {};
Â  Â  Object.keys(chatData).forEach(chatId => {
Â  Â  Â  if(chatId.includes(currentUser.uid)){
Â  Â  Â  Â  myChats[chatId] = chatData[chatId];
Â  Â  Â  }
Â  Â  });
Â  });
}

function computeUnread(){
Â  const chatsRef = ref(db, 'chats');
Â  if(computeUnread._bound) return;
Â  computeUnread._bound = true;

Â  onValue(chatsRef, snap => {
Â  Â  let total = 0;
Â  Â  const chats = snap.val() || {};
Â  Â  for (const chatId in chats) {
Â  Â  Â  if (chatId.includes(currentUser.uid)) {
Â  Â  Â  Â  const otherUid = chatId.replace(currentUser.uid, '').replace('_', '');
Â  Â  Â  Â  const unreadKey = `unread_${otherUid}`;
Â  Â  Â  Â  if (chats[chatId][unreadKey] && chats[chatId][unreadKey][currentUser.uid]) {
Â  Â  Â  Â  Â  total += chats[chatId][unreadKey][currentUser.uid];
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  unreadTotal = total;
Â  Â  if (total > 0) {
Â  Â  Â  bellCount.textContent = total;
Â  Â  Â  bellCount.classList.remove('hidden');
Â  Â  } else {
Â  Â  Â  bellCount.classList.add('hidden');
Â  Â  }
Â  });
}


function startChat(otherUid, otherName, isSidebar){
Â  currentChatUid = otherUid;
Â  const chatId = getChatId(otherUid);
Â  const messagesRef = ref(db, `chats/${chatId}/messages`);

Â  // 1. Setze UI
Â  const inputId = isSidebar ? 'chatSidebarInput' : 'chatFullInput';
Â  const sendId = isSidebar ? 'chatSidebarSend' : 'chatFullSend';

Â  if(isSidebar){
Â  Â  chatSidebarWindow.style.display = 'flex';
Â  Â  chatSidebarTitle.textContent = `Chat mit ${otherName}`;
Â  Â  document.getElementById(inputId).placeholder = `Nachricht an ${otherName}...`;
Â  } else {
Â  Â  chatHeaderFull.textContent = `Chat mit ${otherName}`;
Â  Â  document.getElementById(inputId).placeholder = `Nachricht an ${otherName}...`;
Â  }

Â  // 2. Lade Nachrichten und binde Sender-Events neu (um Duplikate zu verhindern)
Â  const inputEl = document.getElementById(inputId);
Â  const sendBtn = document.getElementById(sendId);

Â  // Ersetze Input und Button, um Event-Listener zu entfernen
Â  inputEl.replaceWith(inputEl.cloneNode(true));
Â  sendBtn.replaceWith(sendBtn.cloneNode(true));

Â  const newChatInput = document.getElementById(inputId);
Â  const newChatSend = document.getElementById(sendId);

Â  const sender = () => sendMessage(otherUid, newChatInput, newChatSend);

Â  newChatSend.addEventListener('click', sender);
Â  newChatInput.addEventListener('keydown', e => {
Â  Â  if(e.key === 'Enter') sender();
Â  });

Â  // Entferne alte onValue-Listener, bevor ein neuer hinzugefÃ¼gt wird
Â  if(startChat.listenerRef) off(messagesRef, 'value', startChat.listenerRef);

Â  const listener = snap=>{
Â  Â  const messages = snap.val() || {};
Â  Â  const msgsEl = isSidebar ? chatSidebarMessages : chatFullMessages;
Â  Â  msgsEl.innerHTML = '';
Â  Â  Object.values(messages).sort((a,b)=>a.time-b.time).forEach(msg=>{
Â  Â  Â  const isMe = msg.authorUid === currentUser.uid;
Â  Â  Â  const m = el('div'); m.className = `msg ${isMe ? 'me' : ''}`;
Â  Â  Â  m.innerHTML = `<div class="bubble">${msg.text}</div>`;
Â  Â  Â  msgsEl.appendChild(m);
Â  Â  });
Â  Â  msgsEl.scrollTop = msgsEl.scrollHeight;
Â  Â  markAsRead(chatId);
Â  };

Â  onValue(messagesRef, listener);
Â  startChat.listenerRef = listener; // Speichere den Listener-Callback zum Entfernen

}

async function sendMessage(otherUid, inputEl, sendBtn){
Â  const text = inputEl.value.trim();
Â  if(!text) return;
Â  sendBtn.disabled = true;
Â  inputEl.disabled = true;

Â  const chatId = getChatId(otherUid);
Â  const msg = {
Â  Â  text,
Â  Â  author: currentUser.first || currentUser.username,
Â  Â  authorUid: currentUser.uid,
Â  Â  time: now(),
Â  Â  read: false
Â  };
Â  const msgPath = `chats/${chatId}/messages`;
Â  await push(ref(db, msgPath), msg);

Â  // Markiere ungelesene fÃ¼r den EmpfÃ¤nger (otherUid)
Â  const unreadPath = `chats/${chatId}/unread_${otherUid}/${otherUid}`;
Â  const unreadCountSnap = await get(ref(db, unreadPath));
Â  const newCount = (unreadCountSnap.val() || 0) + 1;
Â  await set(ref(db, unreadPath), newCount);

Â  inputEl.value = '';
Â  sendBtn.disabled = false;
Â  inputEl.disabled = false;
Â  inputEl.focus();
}

async function markAsRead(chatId){
Â  const unreadPath = `chats/${chatId}/unread_${currentUser.uid}/${currentUser.uid}`;
Â  await set(ref(db, unreadPath), 0);
}


/* THEME */
function setTheme(theme){
Â  const body = document.body;
Â  body.classList.remove('light','green','dark');
Â  if(theme !== 'dark') body.classList.add(theme);
Â  // Update Theme in DB
Â  update(ref(db, `users/${currentUser.uid}`), {theme});
}

/* EMOJI GAME */
const emojiList = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ¤¯', 'ğŸ¥¶', 'ğŸ”¥'];
let currentEmoji = 'ğŸ˜€';
let points = 0;
let multiplier = 1;
let unlockedEmojis = ['ğŸ˜€'];
let levelCost = 20;

function initEmojiGame(loadFromUser = false){
Â  if(loadFromUser){
Â  Â  points = currentUser.points || 0;
Â  Â  multiplier = currentUser.multiplier || 1;
Â  Â  unlockedEmojis = currentUser.unlockedEmojis || ['ğŸ˜€'];
Â  }

Â  if(unlockedEmojis.length > 0){
Â  Â  currentEmoji = unlockedEmojis[unlockedEmojis.length-1];
Â  } else {
Â  Â  currentEmoji = 'ğŸ˜€';
Â  }
Â  activeEmoji.textContent = currentEmoji;
Â  updateGameUI();
}

async function updateGameInDb(){
Â  await update(ref(db, `users/${currentUser.uid}`), {points, multiplier, unlockedEmojis});
}

function updateGameUI(){
Â  gamePointsEl.textContent = points;
Â  upgradeBtn.textContent = `Upgrade (x${multiplier*2} fÃ¼r ${levelCost} Punkte)`;
Â  if(points < levelCost) upgradeBtn.disabled = true; else upgradeBtn.disabled = false;
Â  gameProgress.style.width = `${Math.min(100, (points / levelCost) * 100)}%`;

Â  unlockedList.innerHTML = '';
Â  emojiList.forEach(e=>{
Â  Â  const span = el('span', e);
Â  Â  span.style.opacity = unlockedEmojis.includes(e) ? 1 : 0.2;
Â  Â  span.style.cursor = unlockedEmojis.includes(e) ? 'pointer' : 'default';
Â  Â  if(unlockedEmojis.includes(e)){
Â  Â  Â  span.addEventListener('click', ()=> { currentEmoji = e; activeEmoji.textContent = e; });
Â  Â  }
Â  Â  unlockedList.appendChild(span);
Â  });
}

function clickEmoji(e){
Â  const clicks = multiplier;
Â  points += clicks;
Â  activeEmoji.style.transform = 'scale(0.9)';
Â  setTimeout(()=> activeEmoji.style.transform = 'scale(1)', 80);

Â  spawnParticle(e.clientX, e.clientY, `+${clicks}`);

Â  checkUnlock();
Â  updateGameUI();
Â  updateGameInDb();
}

function spawnParticle(x, y, text){
Â  const p = el('div', text);
Â  p.className = 'particle';
Â  p.style.left = `${x}px`;
Â  p.style.top = `${y}px`;
Â  document.body.appendChild(p);
Â  setTimeout(()=>{
Â  Â  p.style.opacity = 1;
Â  Â  p.style.transform = `translate(-50%, -150px) scale(1.2)`;
Â  }, 10);
Â  setTimeout(()=> p.remove(), 500);
}

function upgradeMultiplier(){
Â  if(points >= levelCost){
Â  Â  points -= levelCost;
Â  Â  multiplier *= 2;
Â  Â  levelCost *= 4;
Â  Â  updateGameUI();
Â  Â  updateGameInDb();
Â  }
}

function checkUnlock(){
Â  const currentUnlockIndex = unlockedEmojis.length;
Â  if(currentUnlockIndex < emojiList.length){
Â  Â  const neededPoints = [0, 5, 20, 50, 100, 250, 500, 1000, 2000, 5000];
Â  Â  if(points >= neededPoints[currentUnlockIndex]){
Â  Â  Â  const newEmoji = emojiList[currentUnlockIndex];
Â  Â  Â  unlockedEmojis.push(newEmoji);
Â  Â  Â  currentEmoji = newEmoji;
Â  Â  Â  activeEmoji.textContent = newEmoji;
Â  Â  Â  alert(`ğŸ¥³ Neues Emoji freigeschaltet: ${newEmoji}!`);
Â  Â  }
Â  }
}

function resetGame(){
Â  if(confirm('Spielstand zurÃ¼cksetzen? Punkte, Multiplikator und freigeschaltete Emojis gehen verloren!')){
Â  Â  points = 0;
Â  Â  multiplier = 1;
Â  Â  unlockedEmojis = ['ğŸ˜€'];
Â  Â  levelCost = 20;
Â  Â  initEmojiGame();
Â  Â  updateGameInDb();
Â  }
}


// Check if user is already logged in on page load
const storedUid = localStorage.getItem('loggedUser');
if(storedUid){
Â  get(child(ref(db, 'users'), storedUid)).then(snap => {
Â  Â  if(snap.exists()){
Â  Â  Â  currentUser = snap.val();
Â  Â  Â  afterLogin();
Â  Â  }
Â  });
}

</script>
</body>
</html>